<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= nickname %> 雀魂战绩</title>
    <link rel="stylesheet" href="./majsoul_info.css">
    </head>
<body>
    <div id="majsoul-card-root">
        
        <div id="title-bar">
            <img src="../texture2d/title.png" id="title-bg">
            <span id="player-title"><%= nickname %> · UID <%= uid %></span>
        </div>

        <div id="top-section">
            
            <div id="char-card">
                <img src="../texture2d/char_bg.png" class="char-bg">
                <img src="../texture2d/waitingroom.png" class="char-image">
                <img src="../texture2d/char_fg.png" class="char-fg">
            </div>

            <div id="rank-section">
                
                <% function renderRankCard(rankData, mode) { %>
                    <% 
                        const major_rank = rankData.level.major_rank;
                        const minor_rank = rankData.level.minor_rank;
                    %>
                    <div class="rank-card <%= mode === '4' ? 'rank-4' : 'rank-3' %>" style="background-image: url('../texture2d/rank_bg.png');">
                        <div class="rank-icon">
                            <img src="../texture2d/<%= major_rank %>_<%= mode %>.png" class="rank-major-icon">
                            <div class="stars-container">
                                <% for (let i = 0; i < 3; i++) { %>
                                    <% const starImg = minor_rank > i ? 'star_full.png' : 'star_empty.png'; %>
                                    <img src="../texture2d/<%= starImg %>" class="star">
                                <% } %>
                            </div>
                        </div>
                        
                        <div class="rank-text-container">
                            <span class="rank-tag-main"><%= rankData.level.full_tag || '暂无段位' %></span>
                            <span class="rank-games">对局数: <%= rankData.stats.game_count || 0 %></span>
                            <span class="rank-win">和了率: <%= rankData.stats.win_rate ? (rankData.stats.win_rate * 100).toFixed(2) + '%' : '0.00%' %></span>
                            <span class="rank-rate">放铳率: <%= rankData.stats.negative_rate ? (rankData.stats.negative_rate * 100).toFixed(2) + '%' : '0.00%' %></span>
                        </div>
                    </div>
                <% } %>

                <%= renderRankCard(rank4, '4') %>
                <%= renderRankCard(rank3, '3') %>
            </div>
        </div>

        <div id="mid-bar">
            <img src="../texture2d/mid.png" id="mid-bg">
            <span id="mode-text"><%= _mode %></span>
        </div>
        
        <div id="detail-bg">
            <% 
                const labels = ["自摸率", "默听率", "流局率", "流听率", "副露率", "立直率", 
                                "和了巡数", "平均打点", "平均铳点", "被放铳率", "一发率", "净打点效率"]; 
            %>
            <div id="detail-grid">
                <% for(let i = 0; i < detail_data_values.length; i++) { %>
                    <div class="detail-item">
                        <div class="label"><%= labels[i] %></div>
                        <div class="value"><%= detail_data_values[i] %></div>
                    </div>
                <% } %>
            </div>
        </div>
        
        <div id="bar-charts">
            
            <% function renderBar(data, label1, label2, label3) { %>
                <% 
                    const v1_rate = data.v1 || 0;
                    const v2_rate = data.v2 || 0;
                    const v3_rate = data.v3 || (1 - v1_rate - v2_rate) || 0;
                    
                    const total_width = 770; 
                    const gap = 10;
                    const v1_width = v1_rate * total_width;
                    const v2_width = v2_rate * total_width;
                    const v3_width = data.type !== 'chong' ? v3_rate * total_width : total_width - v1_width - v2_width;
                %>
                <div class="bar-row">
                    <div class="bar-label-left"><%= label1 %></div>
                    
                    <div class="bar-container" style="background-image: url('../texture2d/lz_<%= data.type %>.png');">
                        <div class="bar-segment" style="background-color: var(--color-lz); width: <%= v1_width %>px; left: 0;"></div>
                        
                        <div class="bar-segment" style="background-color: var(--color-fl); width: <%= v2_width %>px; left: <%= v1_width %>px;"></div>
                        
                        <% if(data.type !== 'chong') { %>
                            <div class="bar-segment" style="background-color: var(--color-mt); width: <%= v3_width %>px; left: <%= v1_width + v2_width %>px;"></div>
                        <% } %>
                    </div>

                    <div class="bar-labels-right">
                        <span class="label-v1"><%= label1 %></span>
                        <span class="label-v2"><%= label2 %></span>
                        <span class="label-v3"><%= label3 %></span>
                    </div>
                </div>
            <% } %>

            <%= renderBar(bar_data.lz_rong, '和了构成', '立直和了', '副露和了', '默听和了') %>
            <%= renderBar(bar_data.lz_chong, '放铳构成', '放铳时立直', '放铳时副露', '其他') %>
            <%= renderBar(bar_data.lz_chongz, '放铳去向', '放铳至立直', '放铳至副露', '放铳至默听') %>

        </div>

        <img src="../texture2d/footer.png" id="footer">
    </div>
</body>
</html>